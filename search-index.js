crystal_doc_search_index_callback({"repository_name":"github.com/onyxframework/background","body":"# Onyx::Background\n\n[![Built with Crystal](https://img.shields.io/badge/built%20with-crystal-000000.svg?style=flat-square)](https://crystal-lang.org)\n[![Travis CI build](https://img.shields.io/travis/com/onyxframework/background/master.svg?style=flat-square)](https://travis-ci.com/onyxframework/background)\n[![API docs](https://img.shields.io/badge/api_docs-online-brightgreen.svg?style=flat-square)](https://api.onyxframework.org/background)\n[![Latest release](https://img.shields.io/github/release/onyxframework/background.svg?style=flat-square)](https://github.com/onyxframework/background/releases)\n\nA fast background job processing for [Crystal](https://crystal-lang.org).\n\n## About\n\nThis is a [Redis](https://redis.io)-based background jobs processing for [Crystal](https://crystal-lang.org) alternative to [sidekiq](https://github.com/mperham/sidekiq.cr) and [mosquito](https://github.com/robacarp/mosquito). It's a component of [Onyx Framework](https://github.com/onyxframework), but can be used separately.\n\n### Features\n\nThis publicly available open-source version has the following functionality:\n\n* Enqueuing jobs for immediate processing\n* Enqueuing jobs for delayed processing (i.e. `in: 5.minutes` or `at: Time.now + 1.hour`)\n* Different job queues (`\"default\"` by default)\n* Concurrent jobs processing (with a separate Redis client for each fiber)\n* Verbose Redis logging of all the activity (i.e. every attempt made)\n* Moving stale jobs (i.e. with dead workers) to the failed list\n\n### Performance\n\nThorough benchmaring is to be done yet, however, currently a single Worker is able to process more than **7500 jobs per second** on my 0.9GHz machine with Redis instance running on itself.\n\n## Installation\n\nOnyx::Background works with Redis version `~> 5.0`.\n\nAdd this to your application's `shard.yml`:\n\n```yaml\ndependencies:\n  onyx-background:\n    github: onyxframework/background\n    version: ~> 0.1.0\n```\n\nThis shard follows [Semantic Versioning v2.0.0](http://semver.org/), so check [releases](https://github.com/onyxframework/background/releases) and change the `version` accordingly.\n\n## Usage\n\n### API docs\n\nPlease refer to API documentation available online: [https://api.onyxframework.org/background](https://api.onyxframework.org/background)\n\n*Note: it is updated on every master branch commit*\n\n### Example\n\n```crystal\n# app.cr\nrequire \"onyx-background\"\n\nstruct Jobs::Nap\n  include Onyx::Background::Job\n\n  def initialize(@sleep : Int32 = 1)\n  end\n\n  def perform\n    sleep(@sleep)\n  end\nend\n\nbackground = Onyx::Background.new\nbackground.enqueue(Jobs::Nap.new(3))\n\nputs \"Enqueued\"\n```\n\nWorker side:\n\n```crystal\n# worker.cr\nrequire \"onyx-background\"\n\nworker = Onyx::Background::Worker.new\nworker.run\n```\n\n```console\n$ crystal app.cr\nEnqueued\n$ crystal worker.cr\nI -- worker: Working...\nD -- worker: Waiting for a new job...\nD -- worker: [fa5b6d65-46fe-4c88-829f-d69023c4c6de] Attempting\nD -- worker: [fa5b6d65-46fe-4c88-829f-d69023c4c6de] Performing Jobs::Nap {\"sleep\":1}...\nD -- worker: [fa5b6d65-46fe-4c88-829f-d69023c4c6de] Completed\nD -- worker: Waiting for a new job...\n```\n\nIt's also highly recommended to run a Watcher process to watch for stale jobs. If you're queuing delayed jobs, the Watcher is **required** to move the jobs to the ready queue on time:\n\n```\n# watcher.cr\nrequire \"onyx-background\"\n\nwatcher = Onyx::Background::Watcher.new\nwatcher.run\n```\n\n## Development\n\nRedis is flushed during the spec, so you **must** specify a safe-to-flush Redis database in the `REDIS_URL`. To run the specs, use the following command:\n\n```console\n$ env REDIS_URL=redis://localhost:6379/1 crystal spec\n```\n\n## Contributing\n\n1. Fork it (<https://github.com/onyxframework/background/fork>)\n2. Create your feature branch (`git checkout -b my-new-feature`)\n3. Commit your changes (`git commit -am 'Add some feature'`)\n4. Push to the branch (`git push origin my-new-feature`)\n5. Create a new Pull Request\n\n\n## Contributors\n\n- [@vladfaust](https://github.com/vladfaust) Vlad Faust - creator, maintainer\n\n## Licensing\n\nThis software is licensed under BSD 3-Clause License with \"Commons Clause\" License Condition v1.0. See [LICENSE](LICENSE).\n","program":{"html_id":"github.com/onyxframework/background/toplevel","path":"toplevel.html","kind":"module","full_name":"Top Level Namespace","name":"Top Level Namespace","abstract":false,"superclass":null,"ancestors":[],"locations":[],"repository_name":"github.com/onyxframework/background","program":true,"enum":false,"alias":false,"aliased":"","const":false,"constants":[],"included_modules":[],"extended_modules":[],"subclasses":[],"including_types":[],"namespace":null,"doc":null,"summary":null,"class_methods":[],"constructors":[],"instance_methods":[],"macros":[],"types":[{"html_id":"github.com/onyxframework/background/Onyx","path":"Onyx.html","kind":"class","full_name":"Onyx","name":"Onyx","abstract":false,"superclass":{"html_id":"github.com/onyxframework/background/Reference","kind":"class","full_name":"Reference","name":"Reference"},"ancestors":[{"html_id":"github.com/onyxframework/background/Reference","kind":"class","full_name":"Reference","name":"Reference"},{"html_id":"github.com/onyxframework/background/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"onyx-background.cr","line_number":2,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background.cr"}],"repository_name":"github.com/onyxframework/background","program":false,"enum":false,"alias":false,"aliased":"","const":false,"constants":[],"included_modules":[],"extended_modules":[],"subclasses":[],"including_types":[],"namespace":null,"doc":"Powerful framework for modern applications. See [onyxframework.org](https://onyxframework.org).","summary":"<p>Powerful framework for modern applications.</p>","class_methods":[],"constructors":[],"instance_methods":[],"macros":[],"types":[{"html_id":"github.com/onyxframework/background/Onyx/Background","path":"Onyx/Background.html","kind":"class","full_name":"Onyx::Background","name":"Background","abstract":false,"superclass":{"html_id":"github.com/onyxframework/background/Reference","kind":"class","full_name":"Reference","name":"Reference"},"ancestors":[{"html_id":"github.com/onyxframework/background/Reference","kind":"class","full_name":"Reference","name":"Reference"},{"html_id":"github.com/onyxframework/background/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"onyx-background.cr","line_number":4,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background.cr"},{"filename":"onyx-background/job.cr","line_number":4,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/job.cr"}],"repository_name":"github.com/onyxframework/background","program":false,"enum":false,"alias":false,"aliased":"","const":false,"constants":[],"included_modules":[],"extended_modules":[],"subclasses":[],"including_types":[],"namespace":{"html_id":"github.com/onyxframework/background/Onyx","kind":"class","full_name":"Onyx","name":"Onyx"},"doc":"A fast background job processing for Crystal.","summary":"<p>A fast background job processing for Crystal.</p>","class_methods":[],"constructors":[],"instance_methods":[],"macros":[],"types":[{"html_id":"github.com/onyxframework/background/Onyx/Background/Job","path":"Onyx/Background/Job.html","kind":"module","full_name":"Onyx::Background::Job","name":"Job","abstract":false,"superclass":null,"ancestors":[],"locations":[{"filename":"onyx-background/job.cr","line_number":37,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/job.cr"}],"repository_name":"github.com/onyxframework/background","program":false,"enum":false,"alias":false,"aliased":"","const":false,"constants":[],"included_modules":[],"extended_modules":[],"subclasses":[],"including_types":[],"namespace":{"html_id":"github.com/onyxframework/background/Onyx/Background","kind":"class","full_name":"Onyx::Background","name":"Background"},"doc":"Include this module to turn an object into an Onyx Job.\n\nWhen a Job is queued, its instance is serialized into JSON.\nWhen a Job is extracted from the queue for performing, it's deserialized from JSON.\n\nThis module includes `JSON::Serializable`, making *all* instance variables serializeable by default.\n\n```\n# This job will sleep for certain time.\nstruct MyJob\n  include Onyx::Background::Job\n\n  # This variable in ignored on serialization\n  @[JSON::Field(ignore: true)]\n  @foo : String\n\n  def initialize(@sleep : Int32)\n    @foo = \"bar\"\n  end\n\n  def perform\n    sleep(@sleep)\n    puts \"Completed!\" # Will print into the worker STDOUT\n  end\nend\n\nbackground = Onyx::Background::Manager.new\njob = MyJob.new(1)\n\n# Add the job to the \"default\" queue\nmanager.enqueue(job) # Will save it with {\"sleep\": 1} payload\n```","summary":"<p>Include this module to turn an object into an Onyx Job.</p>","class_methods":[{"id":"queue:String-class-method","html_id":"queue:String-class-method","name":"queue","doc":"The default queue for this job. Defaults to `\"default\"`.\nCan be overwritten on `Manager#enqueue`.","summary":"<p>The default queue for this job.</p>","abstract":false,"args":[],"args_string":" : String","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/job.cr#L54","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/job.cr#L54","def":{"name":"queue","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"String","visibility":"Public","body":"raise(NotImplementedError.new)"}},{"id":"queue=(value:String)-class-method","html_id":"queue=(value:String)-class-method","name":"queue=","doc":"The default queue for this job. Defaults to `\"default\"`.\nCan be overwritten on `Manager#enqueue`.","summary":"<p>The default queue for this job.</p>","abstract":false,"args":[{"name":"value","doc":null,"default_value":"","external_name":"value","restriction":"String"}],"args_string":"(value : String)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/job.cr#L59","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/job.cr#L59","def":{"name":"queue=","args":[{"name":"value","doc":null,"default_value":"","external_name":"value","restriction":"String"}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"raise(NotImplementedError.new)"}}],"constructors":[{"id":"new-class-method","html_id":"new-class-method","name":"new","doc":"Must be implemented by the including job.","summary":"<p>Must be implemented by the including job.</p>","abstract":false,"args":[],"args_string":"","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/job.cr#L42","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/job.cr#L42","def":{"name":"new","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"_ = allocate\n_.initialize\nif _.responds_to?(:finalize)\n  ::GC.add_finalizer(_)\nend\n_\n"}}],"instance_methods":[{"id":"attempt_uuid:String-instance-method","html_id":"attempt_uuid:String-instance-method","name":"attempt_uuid","doc":"Return the current attempt UUID as a `String`. Usually set by `Worker`.","summary":"<p>Return the current attempt UUID as a <code>String</code>.</p>","abstract":false,"args":[],"args_string":" : String","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/job.cr#L48","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/job.cr#L48","def":{"name":"attempt_uuid","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"String","visibility":"Public","body":"@attempt_uuid.not_nil!"}},{"id":"perform-instance-method","html_id":"perform-instance-method","name":"perform","doc":"Must be implemented by the including job.","summary":"<p>Must be implemented by the including job.</p>","abstract":true,"args":[],"args_string":"","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/job.cr#L39","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/job.cr#L39","def":{"name":"perform","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":""}}],"macros":[],"types":[]},{"html_id":"github.com/onyxframework/background/Onyx/Background/JobNotFoundByUUID","path":"Onyx/Background/JobNotFoundByUUID.html","kind":"class","full_name":"Onyx::Background::JobNotFoundByUUID","name":"JobNotFoundByUUID","abstract":false,"superclass":{"html_id":"github.com/onyxframework/background/Exception","kind":"class","full_name":"Exception","name":"Exception"},"ancestors":[{"html_id":"github.com/onyxframework/background/Exception","kind":"class","full_name":"Exception","name":"Exception"},{"html_id":"github.com/onyxframework/background/Reference","kind":"class","full_name":"Reference","name":"Reference"},{"html_id":"github.com/onyxframework/background/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"onyx-background.cr","line_number":6,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background.cr"}],"repository_name":"github.com/onyxframework/background","program":false,"enum":false,"alias":false,"aliased":"","const":false,"constants":[],"included_modules":[],"extended_modules":[],"subclasses":[],"including_types":[],"namespace":{"html_id":"github.com/onyxframework/background/Onyx/Background","kind":"class","full_name":"Onyx::Background","name":"Background"},"doc":"Raised when a job is not found by its `UUID`.","summary":"<p>Raised when a job is not found by its <code>UUID</code>.</p>","class_methods":[],"constructors":[{"id":"new(uuid)-class-method","html_id":"new(uuid)-class-method","name":"new","doc":null,"summary":null,"abstract":false,"args":[{"name":"uuid","doc":null,"default_value":"","external_name":"uuid","restriction":""}],"args_string":"(uuid)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background.cr#L9","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background.cr#L9","def":{"name":"new","args":[{"name":"uuid","doc":null,"default_value":"","external_name":"uuid","restriction":""}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"_ = allocate\n_.initialize(uuid)\nif _.responds_to?(:finalize)\n  ::GC.add_finalizer(_)\nend\n_\n"}}],"instance_methods":[{"id":"uuid:UUID|String-instance-method","html_id":"uuid:UUID|String-instance-method","name":"uuid","doc":null,"summary":null,"abstract":false,"args":[],"args_string":" : UUID | String","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background.cr#L7","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background.cr#L7","def":{"name":"uuid","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"UUID | String","visibility":"Public","body":"@uuid"}}],"macros":[],"types":[]},{"html_id":"github.com/onyxframework/background/Onyx/Background/Manager","path":"Onyx/Background/Manager.html","kind":"class","full_name":"Onyx::Background::Manager","name":"Manager","abstract":false,"superclass":{"html_id":"github.com/onyxframework/background/Reference","kind":"class","full_name":"Reference","name":"Reference"},"ancestors":[{"html_id":"github.com/onyxframework/background/Reference","kind":"class","full_name":"Reference","name":"Reference"},{"html_id":"github.com/onyxframework/background/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"onyx-background/manager.cr","line_number":21,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/manager.cr"}],"repository_name":"github.com/onyxframework/background","program":false,"enum":false,"alias":false,"aliased":"","const":false,"constants":[],"included_modules":[],"extended_modules":[],"subclasses":[],"including_types":[],"namespace":{"html_id":"github.com/onyxframework/background/Onyx/Background","kind":"class","full_name":"Onyx::Background","name":"Background"},"doc":"The background processing manager.\n\nIt's intended for use within an application to enqueue and dequeue jobs.\n\nApart from a standard `Redis` instance, the Manager supports\n[`Redis::TransactionApi`](http://stefanwille.github.io/crystal-redis/Redis/TransactionApi.html)\nand [`Redis::PipelineApi`](http://stefanwille.github.io/crystal-redis/Redis/PipelineApi.html),\nwhich allows to use it in a `multi` or `pipelined` block:\n\n```\nredis.pipelined do |pipe|\n  manager = Onyx::Background::Manager.new(pipe)\n\n  100.times do\n    manager.enqueue(MyJob) # All 100 enqueues will happen in one pipe, which is much faster\n  end\nend\n```","summary":"<p>The background processing manager.</p>","class_methods":[],"constructors":[{"id":"new(redis:Redis|Redis::TransactionApi|Redis::PipelineApi=Redis.new,namespace:String=&quot;onyx-background&quot;)-class-method","html_id":"new(redis:Redis|Redis::TransactionApi|Redis::PipelineApi=Redis.new,namespace:String=&amp;quot;onyx-background&amp;quot;)-class-method","name":"new","doc":"Initialize a new `Manager`.\n\nArguments:\n\n* *redis* -- a Redis instance to use\n* *namespace* -- a Redis namespace to work in","summary":"<p>Initialize a new <code><a href=\"../../Onyx/Background/Manager.html\">Manager</a></code>.</p>","abstract":false,"args":[{"name":"redis","doc":null,"default_value":"Redis.new","external_name":"redis","restriction":"Redis | Redis::TransactionApi | Redis::PipelineApi"},{"name":"namespace","doc":null,"default_value":"\"onyx-background\"","external_name":"namespace","restriction":"String"}],"args_string":"(redis : Redis | Redis::TransactionApi | Redis::PipelineApi = <span class=\"t\">Redis</span>.<span class=\"k\">new</span>, namespace : String = <span class=\"s\">&quot;onyx-background&quot;</span>)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/manager.cr#L36","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/manager.cr#L36","def":{"name":"new","args":[{"name":"redis","doc":null,"default_value":"Redis.new","external_name":"redis","restriction":"Redis | Redis::TransactionApi | Redis::PipelineApi"},{"name":"namespace","doc":null,"default_value":"\"onyx-background\"","external_name":"namespace","restriction":"String"}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"_ = allocate\n_.initialize(redis, namespace)\nif _.responds_to?(:finalize)\n  ::GC.add_finalizer(_)\nend\n_\n"}}],"instance_methods":[{"id":"dequeue(job_uuiduuid:UUID|String)-instance-method","html_id":"dequeue(job_uuiduuid:UUID|String)-instance-method","name":"dequeue","doc":"Remove a job by its *job_uuid*.\nRaises `JobNotFoundByUUID` if the job itself is not found or its queue in `nil`.\nReturns falsey value if the job is not in the queue,\nwhich means it's either already performed, removed or never been there.","summary":"<p>Remove a job by its <em>job_uuid</em>.</p>","abstract":false,"args":[{"name":"uuid","doc":null,"default_value":"","external_name":"job_uuid","restriction":"UUID | String"}],"args_string":"(job_uuid uuid : UUID | String)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/manager.cr#L146","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/manager.cr#L146","def":{"name":"dequeue","args":[{"name":"uuid","doc":null,"default_value":"","external_name":"job_uuid","restriction":"UUID | String"}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"queue = redis.hget(\"#{@namespace}:jobs:#{uuid}\", \"que\")\nif queue\nelse\n  raise(JobNotFoundByUUID.new(uuid))\nend\ncase redis\nwhen Redis\n  _, scheduled, ready = (redis.as(Redis)).multi do |multi|\n    multi.del(\"#{@namespace}:jobs:#{uuid}\")\n    multi.zrem(\"#{@namespace}:queues:scheduled:#{queue}\", uuid)\n    multi.lrem(\"#{@namespace}:queues:ready:#{queue}\", 0, uuid)\n  end\nelse\n  redis.del(\"#{@namespace}:jobs:#{uuid}\")\n  scheduled = redis.zrem(\"#{@namespace}:queues:scheduled:#{queue}\", uuid)\n  ready = redis.lrem(\"#{@namespace}:queues:ready:#{queue}\", 0, uuid)\nend\nreturn (scheduled && (scheduled.as(Int64)) > 0) || (ready && (ready.as(Int64)) > 0)\n"}},{"id":"enqueue(job:Job,**nargs)-instance-method","html_id":"enqueue(job:Job,**nargs)-instance-method","name":"enqueue","doc":"Enqueue a *job* instance. See [`#enqueue`](#enqueue%28classklass%3AString%2Cpayload%3AString%3D%26quot%3B%7B%7D%26quot%3B%2C%2A%2Cqueue%3AString%3D%26quot%3Bdefault%26quot%3B%2Cin%3ATime%3A%3ASpan%3F%3Dnil%2Cat%3ATime%3F%3Dnil%29-instance-method) for options.\n\nExample:\n\n```\nmanager.enqueue(MyJob.new(5), at: Time.now + 5.minutes)\n```","summary":"<p>Enqueue a <em>job</em> instance.</p>","abstract":false,"args":[{"name":"job","doc":null,"default_value":"","external_name":"job","restriction":"Job"}],"args_string":"(job : Job, **nargs)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/manager.cr#L55","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/manager.cr#L55","def":{"name":"enqueue","args":[{"name":"job","doc":null,"default_value":"","external_name":"job","restriction":"Job"}],"double_splat":{"name":"nargs","doc":null,"default_value":"","external_name":"nargs","restriction":""},"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"enqueue(job.class.to_s, job.to_json, **nargs)"}},{"id":"enqueue(job:Job.class,**nargs)-instance-method","html_id":"enqueue(job:Job.class,**nargs)-instance-method","name":"enqueue","doc":"Enqueue a *job* by its class (will be instantiated without arguments).\nSee [`#enqueue`](#enqueue%28classklass%3AString%2Cpayload%3AString%3D%26quot%3B%7B%7D%26quot%3B%2C%2A%2Cqueue%3AString%3D%26quot%3Bdefault%26quot%3B%2Cin%3ATime%3A%3ASpan%3F%3Dnil%2Cat%3ATime%3F%3Dnil%29-instance-method) for options.\n\nExample:\n\n```\nmanager.enqueue(MyJob, in: 5.minutes)\n```","summary":"<p>Enqueue a <em>job</em> by its class (will be instantiated without arguments).</p>","abstract":false,"args":[{"name":"job","doc":null,"default_value":"","external_name":"job","restriction":"Job.class"}],"args_string":"(job : Job.class, **nargs)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/manager.cr#L67","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/manager.cr#L67","def":{"name":"enqueue","args":[{"name":"job","doc":null,"default_value":"","external_name":"job","restriction":"Job.class"}],"double_splat":{"name":"nargs","doc":null,"default_value":"","external_name":"nargs","restriction":""},"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"enqueue(job.to_s, **nargs)"}},{"id":"enqueue(classklass:String,payload:String=&quot;{}&quot;,*,queue:String=&quot;default&quot;,in:Time::Span?=nil,at:Time?=nil)-instance-method","html_id":"enqueue(classklass:String,payload:String=&amp;quot;{}&amp;quot;,*,queue:String=&amp;quot;default&amp;quot;,in:Time::Span?=nil,at:Time?=nil)-instance-method","name":"enqueue","doc":"Enqueue a job by its *class* name with JSON *payload*.\n\nArguments:\n\n* *queue* -- a queue to put the job in\n* *in* -- a time span to queue the job in\n* *at* -- a time to queue the job at\n\nExample:\n\n```\nmanager.enqueue(\"SomeNamespace::MyJob\", %Q[{\"foo\":\"bar\"}], queue: \"regular\", in: 5.minutes)\n```","summary":"<p>Enqueue a job by its <em>class</em> name with JSON <em>payload</em>.</p>","abstract":false,"args":[{"name":"klass","doc":null,"default_value":"","external_name":"class","restriction":"String"},{"name":"payload","doc":null,"default_value":"\"{}\"","external_name":"payload","restriction":"String"},{"name":"","doc":null,"default_value":"","external_name":"","restriction":""},{"name":"queue","doc":null,"default_value":"\"default\"","external_name":"queue","restriction":"String"},{"name":"in","doc":null,"default_value":"nil","external_name":"in","restriction":"Time::Span | ::Nil"},{"name":"at","doc":null,"default_value":"nil","external_name":"at","restriction":"Time | ::Nil"}],"args_string":"(class klass : String, payload : String = <span class=\"s\">&quot;{}&quot;</span>, *, queue : String = <span class=\"s\">&quot;default&quot;</span>, in : Time::Span? = <span class=\"n\">nil</span>, at : Time? = <span class=\"n\">nil</span>)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/manager.cr#L84","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/manager.cr#L84","def":{"name":"enqueue","args":[{"name":"klass","doc":null,"default_value":"","external_name":"class","restriction":"String"},{"name":"payload","doc":null,"default_value":"\"{}\"","external_name":"payload","restriction":"String"},{"name":"","doc":null,"default_value":"","external_name":"","restriction":""},{"name":"queue","doc":null,"default_value":"\"default\"","external_name":"queue","restriction":"String"},{"name":"in","doc":null,"default_value":"nil","external_name":"in","restriction":"Time::Span | ::Nil"},{"name":"at","doc":null,"default_value":"nil","external_name":"at","restriction":"Time | ::Nil"}],"double_splat":null,"splat_index":2,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"uuid = UUID.random\ncase redis\nwhen Redis\n  (redis.as(Redis)).pipelined do |pipe|\n    save_job(pipe)\n  end\nelse\n  save_job(redis)\nend\nreturn uuid\n"}}],"macros":[],"types":[]},{"html_id":"github.com/onyxframework/background/Onyx/Background/Watcher","path":"Onyx/Background/Watcher.html","kind":"class","full_name":"Onyx::Background::Watcher","name":"Watcher","abstract":false,"superclass":{"html_id":"github.com/onyxframework/background/Reference","kind":"class","full_name":"Reference","name":"Reference"},"ancestors":[{"html_id":"github.com/onyxframework/background/Reference","kind":"class","full_name":"Reference","name":"Reference"},{"html_id":"github.com/onyxframework/background/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"onyx-background/watcher.cr","line_number":15,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/watcher.cr"}],"repository_name":"github.com/onyxframework/background","program":false,"enum":false,"alias":false,"aliased":"","const":false,"constants":[],"included_modules":[],"extended_modules":[],"subclasses":[],"including_types":[],"namespace":{"html_id":"github.com/onyxframework/background/Onyx/Background","kind":"class","full_name":"Onyx::Background","name":"Background"},"doc":"Watches for ready and stale jobs.\n\nIn particular:\n\n* Watches scheduled jobs and moves them to the \"ready\" queue when the time is right\n* Watches a job's worker status, failing the job if the worker is offline\n\nIn general, it's recommended to always run a Watcher, even if you don't have scheduled jobs,\nbecause it also detects stale jobs.\n\nNOTE: There must be only one watcher in the whole application to avoid possible intersection errors.","summary":"<p>Watches for ready and stale jobs.</p>","class_methods":[],"constructors":[{"id":"new(queues:Enumerable(String)={&quot;default&quot;},redis:Redis=Redis.new,logger:Logger=Logger.new,namespace:String=&quot;onyx-background&quot;)-class-method","html_id":"new(queues:Enumerable(String)={&amp;quot;default&amp;quot;},redis:Redis=Redis.new,logger:Logger=Logger.new,namespace:String=&amp;quot;onyx-background&amp;quot;)-class-method","name":"new","doc":"Initialize a new `Watcher`. Call `run` afterwards to run it.\n\n```\nwatcher = Onyx::Background::Watcher.new\nwatcher.run\n```\n\nNOTE: Currently it's highly recommended to run a single watcher\nwithin the whole application to avoid intersection errors.\n\nArguments:\n\n* *queues* -- queues to watch\n* *redis* -- a Redis instance to use\n* *logger* -- a Logger instance to use for logging\n* *namespace* -- the Redis namespace to work in","summary":"<p>Initialize a new <code><a href=\"../../Onyx/Background/Watcher.html\">Watcher</a></code>.</p>","abstract":false,"args":[{"name":"queues","doc":null,"default_value":"{\"default\"}","external_name":"queues","restriction":"Enumerable(String)"},{"name":"redis","doc":null,"default_value":"Redis.new","external_name":"redis","restriction":"Redis"},{"name":"logger","doc":null,"default_value":"Logger.new","external_name":"logger","restriction":"Logger"},{"name":"namespace","doc":null,"default_value":"\"onyx-background\"","external_name":"namespace","restriction":"String"}],"args_string":"(queues : Enumerable(String) = {<span class=\"s\">&quot;default&quot;</span>}, redis : Redis = <span class=\"t\">Redis</span>.<span class=\"k\">new</span>, logger : Logger = <span class=\"t\">Logger</span>.<span class=\"k\">new</span>, namespace : String = <span class=\"s\">&quot;onyx-background&quot;</span>)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/watcher.cr#L59","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/watcher.cr#L59","def":{"name":"new","args":[{"name":"queues","doc":null,"default_value":"{\"default\"}","external_name":"queues","restriction":"Enumerable(String)"},{"name":"redis","doc":null,"default_value":"Redis.new","external_name":"redis","restriction":"Redis"},{"name":"logger","doc":null,"default_value":"Logger.new","external_name":"logger","restriction":"Logger"},{"name":"namespace","doc":null,"default_value":"\"onyx-background\"","external_name":"namespace","restriction":"String"}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"_ = allocate\n_.initialize(queues, redis, logger, namespace)\nif _.responds_to?(:finalize)\n  ::GC.add_finalizer(_)\nend\n_\n"}}],"instance_methods":[{"id":"run-instance-method","html_id":"run-instance-method","name":"run","doc":"Begin watching. Blocks the runtime. Call `#stop` from another fiber to stop it.","summary":"<p>Begin watching.</p>","abstract":false,"args":[],"args_string":"","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/watcher.cr#L69","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/watcher.cr#L69","def":{"name":"run","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"@running = true\n@logger.info(\"Watching...\")\nloop do\n  if @stopping\n    break\n  end\n  raw_processing_attempt_uuids = uninitialized Redis::Future\n  client_list = uninitialized Redis::Future\n  @redis.multi do |multi|\n    raw_processing_attempt_uuids = multi.smembers(\"#{@namespace}:processing\")\n    client_list = multi.client_list(:normal)\n  end\n  processing_attempt_uuids = (raw_processing_attempt_uuids.value.as(Array)).map do |__arg0|\n    __arg0.as(String)\n  end\n  if processing_attempt_uuids.any?\n    fibers = ((client_list.value.as(String)).split(\"\\n\")).map do |client|\n      (client.match(/id=(?<id>\\d+).+name=onyx-background-worker-fiber/)).try(&.[](\"id\"))\n    end.compact\n    hash = Hash(String, Redis::Future).new\n    @redis.multi do |multi|\n      processing_attempt_uuids.each do |uuid|\n        hash[uuid] = multi.hget(\"#{@namespace}:attempts:#{uuid}\", \"wrk\")\n      end\n    end\n    stale_attempts = hash.reduce([] of String) do |ary, __arg2|\n      uuid = __arg2[0]\n      client_id = __arg2[1]\n      if client_id.value.nil?\n        @logger.warn(\"[#{uuid}] BUG: Attempt doesn't have \\\"wrk\\\"\")\n        next ary\n      end\n      if fibers.includes?(client_id.value.as(String))\n      else\n        ary << uuid\n      end\n      ary\n    end\n    if stale_attempts.any?\n      @redis.pipelined do |pipe|\n        at = Time.now\n        stale_attempts.each do |uuid|\n          @logger.debug(\"[#{uuid}] Stale attempt, moving to failed\")\n          pipe.hset(\"#{@namespace}:attempts:#{uuid}\", \"err\", \"Worker Timeout\")\n          pipe.srem(\"#{@namespace}:processing\", uuid)\n          pipe.zadd(\"#{@namespace}:failed\", at.to_unix_ms, uuid)\n        end\n      end\n    end\n  end\n  @queues.each do |queue|\n    ready_jobs = @redis.zrangebyscore(\"#{@namespace}:queues:scheduled:#{queue}\", 0, Time.now.to_unix_ms)\n    if ready_jobs.any?\n      @redis.multi do |multi|\n        ready_jobs.each do |uuid|\n          @logger.debug(\"[#{uuid}] Ready, moving to ready queue\")\n          multi.zrem(\"#{@namespace}:queues:scheduled:#{queue}\", uuid)\n          multi.rpush(\"#{@namespace}:queues:ready:#{queue}\", uuid)\n        end\n      end\n    end\n  end\n  sleep(interval)\nend\n@logger.info(\"Stopped\")\n@running = false\n"}},{"id":"running?:Bool-instance-method","html_id":"running?:Bool-instance-method","name":"running?","doc":"Whether is this worker currently working.","summary":"<p>Whether is this worker currently working.</p>","abstract":false,"args":[],"args_string":" : Bool","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/watcher.cr#L41","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/watcher.cr#L41","def":{"name":"running?","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"Bool","visibility":"Public","body":"@running"}},{"id":"stop-instance-method","html_id":"stop-instance-method","name":"stop","doc":"Gracefully stop the watcher. Will wait until the next looping *interval*.","summary":"<p>Gracefully stop the watcher.</p>","abstract":false,"args":[],"args_string":"","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/watcher.cr#L160","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/watcher.cr#L160","def":{"name":"stop","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"@stopping = true"}},{"id":"stopping?:Bool-instance-method","html_id":"stopping?:Bool-instance-method","name":"stopping?","doc":"Whether is this worker told to stop (but not necessarily already stopped).","summary":"<p>Whether is this worker told to stop (but not necessarily already stopped).</p>","abstract":false,"args":[],"args_string":" : Bool","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/watcher.cr#L38","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/watcher.cr#L38","def":{"name":"stopping?","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"Bool","visibility":"Public","body":"@stopping"}}],"macros":[],"types":[]},{"html_id":"github.com/onyxframework/background/Onyx/Background/Worker","path":"Onyx/Background/Worker.html","kind":"class","full_name":"Onyx::Background::Worker","name":"Worker","abstract":false,"superclass":{"html_id":"github.com/onyxframework/background/Reference","kind":"class","full_name":"Reference","name":"Reference"},"ancestors":[{"html_id":"github.com/onyxframework/background/Reference","kind":"class","full_name":"Reference","name":"Reference"},{"html_id":"github.com/onyxframework/background/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"onyx-background/worker/redis_pool.cr","line_number":1,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/worker/redis_pool.cr"},{"filename":"onyx-background/worker.cr","line_number":9,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/worker.cr"}],"repository_name":"github.com/onyxframework/background","program":false,"enum":false,"alias":false,"aliased":"","const":false,"constants":[],"included_modules":[],"extended_modules":[],"subclasses":[],"including_types":[],"namespace":{"html_id":"github.com/onyxframework/background/Onyx/Background","kind":"class","full_name":"Onyx::Background","name":"Background"},"doc":"Actually performs jobs.","summary":"<p>Actually performs jobs.</p>","class_methods":[],"constructors":[{"id":"new(queues:Enumerable(String)={&quot;default&quot;},fibers:Int32=100,redis_proc:Proc(Redis)=->do\nRedis.new\nend,logger:Logger=Logger.new(STDOUT),namespace:String=&quot;onyx-background&quot;)-class-method","html_id":"new(queues:Enumerable(String)={&amp;quot;default&amp;quot;},fibers:Int32=100,redis_proc:Proc(Redis)=-&gt;do\nRedis.new\nend,logger:Logger=Logger.new(STDOUT),namespace:String=&amp;quot;onyx-background&amp;quot;)-class-method","name":"new","doc":"Initialize a new `Worker`. Call `run` afterwards to run it.\n\n```\nworker = Onyx::Background::Worker.new\nworker.run\n```\n\nArguments:\n\n* *queues* -- the job queues this worker will work on\n* *fibers* -- the maximum amount of fibers. Each fiber spawns a Redis client\n* *redis_proc* -- a proc to initialize a new Redis client\n* *logger* -- a Logger instance for this worker\n* *namespace* -- the namespace this worker and its fibers will work in","summary":"<p>Initialize a new <code><a href=\"../../Onyx/Background/Worker.html\">Worker</a></code>.</p>","abstract":false,"args":[{"name":"queues","doc":null,"default_value":"{\"default\"}","external_name":"queues","restriction":"Enumerable(String)"},{"name":"fibers","doc":null,"default_value":"100","external_name":"fibers","restriction":"Int32"},{"name":"redis_proc","doc":null,"default_value":"-> do\n  Redis.new\nend","external_name":"redis_proc","restriction":"Proc(Redis)"},{"name":"logger","doc":null,"default_value":"Logger.new(STDOUT)","external_name":"logger","restriction":"Logger"},{"name":"namespace","doc":null,"default_value":"\"onyx-background\"","external_name":"namespace","restriction":"String"}],"args_string":"(queues : Enumerable(String) = {<span class=\"s\">&quot;default&quot;</span>}, fibers : Int32 = <span class=\"n\">100</span>, redis_proc : Proc(Redis) = -> <span class=\"k\">do</span>\n  <span class=\"t\">Redis</span>.<span class=\"k\">new</span>\n<span class=\"k\">end</span>, logger : Logger = <span class=\"t\">Logger</span>.<span class=\"k\">new</span>(<span class=\"t\">STDOUT</span>), namespace : String = <span class=\"s\">&quot;onyx-background&quot;</span>)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/worker.cr#L58","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/worker.cr#L58","def":{"name":"new","args":[{"name":"queues","doc":null,"default_value":"{\"default\"}","external_name":"queues","restriction":"Enumerable(String)"},{"name":"fibers","doc":null,"default_value":"100","external_name":"fibers","restriction":"Int32"},{"name":"redis_proc","doc":null,"default_value":"-> do\n  Redis.new\nend","external_name":"redis_proc","restriction":"Proc(Redis)"},{"name":"logger","doc":null,"default_value":"Logger.new(STDOUT)","external_name":"logger","restriction":"Logger"},{"name":"namespace","doc":null,"default_value":"\"onyx-background\"","external_name":"namespace","restriction":"String"}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"_ = allocate\n_.initialize(queues, fibers, redis_proc, logger, namespace)\nif _.responds_to?(:finalize)\n  ::GC.add_finalizer(_)\nend\n_\n"}}],"instance_methods":[{"id":"run-instance-method","html_id":"run-instance-method","name":"run","doc":"Begin working. Blocks the runtime.","summary":"<p>Begin working.</p>","abstract":false,"args":[],"args_string":"","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/worker.cr#L75","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/worker.cr#L75","def":{"name":"run","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"if @stopping\n  raise(\"Cannot re-run a stopped worker\")\nend\n@running = true\nlogger.info(\"Working...\")\nspawn do\n  loop do\n    redis_pool_cleanup\n    sleep(1)\n  end\nend\nkeys = @queues.to_a.map do |q|\n  \"#{@namespace}:queues:ready:#{q}\"\nend\nloop do\n  if @stopping\n    break\n  end\n  client, client_id = redis_pool_get\n  @logger.debug(\"Waiting for a new job...\")\n  job_uuid = begin\n    (@redis.blpop(keys, 0)).not_nil![1]\n  rescue ex : Redis::Error\n    if ex.message =~ (/^UNBLOCKED/)\n      break\n    end\n    raise(ex)\n  end\n  spawn(process_job(client, client_id, job_uuid.as(String)))\nend\n@running = false\nlogger.info(\"Stopped\")\n"}},{"id":"running?:Bool-instance-method","html_id":"running?:Bool-instance-method","name":"running?","doc":"Whether is this worker currently working.","summary":"<p>Whether is this worker currently working.</p>","abstract":false,"args":[],"args_string":" : Bool","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/worker.cr#L42","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/worker.cr#L42","def":{"name":"running?","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"Bool","visibility":"Public","body":"@running"}},{"id":"stop(redis:Redis=Redis.new,fibers_force_kill:Bool=false,fibers_timeoutfibers_timeout?:Time::Span?=1.second,fibers_check_interval:Time::Span=1.millisecond)-instance-method","html_id":"stop(redis:Redis=Redis.new,fibers_force_kill:Bool=false,fibers_timeoutfibers_timeout?:Time::Span?=1.second,fibers_check_interval:Time::Span=1.millisecond)-instance-method","name":"stop","doc":"Stop this worker.\nIt needs a separate Redis connection to unblock the worker's client remotely.\nAlways closes the main `#redis` connection (but not `ensure`d).\n\n* If *fibers_force_kill* is `true`, will force close all underlying fibers' connections,\nactive jobs will fail with Redis error\n* If *fibers_force_kill* is `false` and *fibers_timeout* is not `nil`,\nwill wait for *fibers_timeout* until all fibers are completed,\nand force close all fibers if it takes longer time\n* If *fibers_force_kill* is `false` and *fibers_timeout* is `nil`,\nwill not wait for fibers to complete, just close the main connection","summary":"<p>Stop this worker.</p>","abstract":false,"args":[{"name":"redis","doc":null,"default_value":"Redis.new","external_name":"redis","restriction":"Redis"},{"name":"fibers_force_kill","doc":null,"default_value":"false","external_name":"fibers_force_kill","restriction":"Bool"},{"name":"fibers_timeout?","doc":null,"default_value":"1.second","external_name":"fibers_timeout","restriction":"Time::Span | ::Nil"},{"name":"fibers_check_interval","doc":null,"default_value":"1.millisecond","external_name":"fibers_check_interval","restriction":"Time::Span"}],"args_string":"(redis : Redis = <span class=\"t\">Redis</span>.<span class=\"k\">new</span>, fibers_force_kill : Bool = <span class=\"n\">false</span>, fibers_timeout fibers_timeout? : Time::Span? = <span class=\"n\">1</span>.second, fibers_check_interval : Time::Span = <span class=\"n\">1</span>.millisecond)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/worker.cr#L128","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/worker.cr#L128","def":{"name":"stop","args":[{"name":"redis","doc":null,"default_value":"Redis.new","external_name":"redis","restriction":"Redis"},{"name":"fibers_force_kill","doc":null,"default_value":"false","external_name":"fibers_force_kill","restriction":"Bool"},{"name":"fibers_timeout?","doc":null,"default_value":"1.second","external_name":"fibers_timeout","restriction":"Time::Span | ::Nil"},{"name":"fibers_check_interval","doc":null,"default_value":"1.millisecond","external_name":"fibers_check_interval","restriction":"Time::Span"}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"if @stopping\n  raise(\"Worker already stopped\")\nend\nif @running\nelse\n  raise(\"Worker needs to be running to stop\")\nend\n@stopping = true\nredis.client_unblock(@redis_client_id, true)\nif fibers_force_kill\n  redis_pool_clear(@redis)\nelse\n  if fibers_timeout = fibers_timeout?\n    started_at = Time.monotonic\n    loop do\n      if @redis_pool_is_using.values.any?(&.itself)\n        if (Time.monotonic - started_at) > fibers_timeout\n          redis_pool_clear(@redis)\n          break\n        end\n      else\n        break\n      end\n      sleep(fibers_check_interval)\n    end\n  end\nend\n@redis.close\n"}},{"id":"stopping?:Bool-instance-method","html_id":"stopping?:Bool-instance-method","name":"stopping?","doc":"Whether is this worker told to stop (but not necessarily already stopped).","summary":"<p>Whether is this worker told to stop (but not necessarily already stopped).</p>","abstract":false,"args":[],"args_string":" : Bool","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/worker.cr#L39","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/onyx-background/worker.cr#L39","def":{"name":"stopping?","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"Bool","visibility":"Public","body":"@stopping"}}],"macros":[],"types":[]}]}]},{"html_id":"github.com/onyxframework/background/Redis","path":"Redis.html","kind":"class","full_name":"Redis","name":"Redis","abstract":false,"superclass":{"html_id":"github.com/onyxframework/background/Reference","kind":"class","full_name":"Reference","name":"Reference"},"ancestors":[{"html_id":"github.com/onyxframework/background/Redis/CommandExecution/ValueOriented","kind":"module","full_name":"Redis::CommandExecution::ValueOriented","name":"ValueOriented"},{"html_id":"github.com/onyxframework/background/Redis/Commands","kind":"module","full_name":"Redis::Commands","name":"Commands"},{"html_id":"github.com/onyxframework/background/Reference","kind":"class","full_name":"Reference","name":"Reference"},{"html_id":"github.com/onyxframework/background/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"lib/redis/src/redis/commands.cr","line_number":1,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/lib/redis/src/redis/commands.cr"},{"filename":"lib/redis/src/redis/command_execution/value_oriented.cr","line_number":1,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/lib/redis/src/redis/command_execution/value_oriented.cr"},{"filename":"lib/redis/src/redis.cr","line_number":37,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/lib/redis/src/redis.cr"},{"filename":"lib/redis/src/redis/command_execution/future_oriented.cr","line_number":1,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/lib/redis/src/redis/command_execution/future_oriented.cr"},{"filename":"lib/redis/src/redis/strategy/base.cr","line_number":1,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/lib/redis/src/redis/strategy/base.cr"},{"filename":"ext/redis/commands.cr","line_number":1,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr"}],"repository_name":"github.com/onyxframework/background","program":false,"enum":false,"alias":false,"aliased":"","const":false,"constants":[],"included_modules":[{"html_id":"github.com/onyxframework/background/Redis/CommandExecution/ValueOriented","kind":"module","full_name":"Redis::CommandExecution::ValueOriented","name":"ValueOriented"},{"html_id":"github.com/onyxframework/background/Redis/Commands","kind":"module","full_name":"Redis::Commands","name":"Commands"}],"extended_modules":[],"subclasses":[],"including_types":[],"namespace":null,"doc":"The class is the main entry point for the Redis client.\n\n**How to use**:\n\nRequire the package:\n\n```crystal\nrequire \"redis\"\n```\n\nThen instantiate this client class:\n\n```crystal\nredis = Redis.new\n```\n\nThen you can call Redis commands on the `redis` object:\n\n```crystal\nredis.set(\"foo\", \"bar\")\nredis.get(\"foo\")\nredis.incr(\"visitors\")\n```\n\nSee the mixin module [Commands](Redis/Commands.html) for most\nof the available Redis commands such as #incr, #rename, and so on.\n\n**Multithreading / Coroutines**\n\nPlease mind that a Redis object can't be shared across multiple threads/coroutines!\nEach thread/coroutine that wants to talk to Redis needs its own Redis object instance.","summary":"<p>The class is the main entry point for the Redis client.</p>","class_methods":[],"constructors":[],"instance_methods":[],"macros":[],"types":[{"html_id":"github.com/onyxframework/background/Redis/Commands","path":"Redis/Commands.html","kind":"module","full_name":"Redis::Commands","name":"Commands","abstract":false,"superclass":null,"ancestors":[],"locations":[{"filename":"lib/redis/src/redis/commands.cr","line_number":4,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/lib/redis/src/redis/commands.cr"},{"filename":"ext/redis/commands.cr","line_number":2,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr"}],"repository_name":"github.com/onyxframework/background","program":false,"enum":false,"alias":false,"aliased":"","const":false,"constants":[],"included_modules":[],"extended_modules":[],"subclasses":[],"including_types":[{"html_id":"github.com/onyxframework/background/Redis","kind":"class","full_name":"Redis","name":"Redis"}],"namespace":{"html_id":"github.com/onyxframework/background/Redis","kind":"class","full_name":"Redis","name":"Redis"},"doc":"Definition of all Redis commands except pipelining and transactions.\n","summary":"<p>Definition of all Redis commands except pipelining and transactions.</p>","class_methods":[],"constructors":[],"instance_methods":[{"id":"client_getname-instance-method","html_id":"client_getname-instance-method","name":"client_getname","doc":"Get the current connection name. See [https://redis.io/commands/client-getname](https://redis.io/commands/client-getname).","summary":"<p>Get the current connection name.</p>","abstract":false,"args":[],"args_string":"","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L56","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L56","def":{"name":"client_getname","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"string_or_nil_command([\"CLIENT\", \"GETNAME\"])"}},{"id":"client_id-instance-method","html_id":"client_id-instance-method","name":"client_id","doc":"Return the client ID for the current connection. See [https://redis.io/commands/client-id](https://redis.io/commands/client-id).","summary":"<p>Return the client ID for the current connection.</p>","abstract":false,"args":[],"args_string":"","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L28","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L28","def":{"name":"client_id","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"integer_command([\"CLIENT\", \"ID\"])"}},{"id":"client_kill(id:Int)-instance-method","html_id":"client_kill(id:Int)-instance-method","name":"client_kill","doc":"Kill the connection of a client by its ID. See [https://redis.io/commands/client-kill](https://redis.io/commands/client-kill).","summary":"<p>Kill the connection of a client by its ID.</p>","abstract":false,"args":[{"name":"id","doc":null,"default_value":"","external_name":"id","restriction":"Int"}],"args_string":"(id : Int)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L33","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L33","def":{"name":"client_kill","args":[{"name":"id","doc":null,"default_value":"","external_name":"id","restriction":"Int"}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"integer_command([\"CLIENT\", \"KILL\", \"ID\", id.to_s])"}},{"id":"client_list(typetype?:ClientType?=nil)-instance-method","html_id":"client_list(typetype?:ClientType?=nil)-instance-method","name":"client_list","doc":"Get the list of client connections. See [https://redis.io/commands/client-list](https://redis.io/commands/client-list).","summary":"<p>Get the list of client connections.</p>","abstract":false,"args":[{"name":"type?","doc":null,"default_value":"nil","external_name":"type","restriction":"ClientType | ::Nil"}],"args_string":"(type type? : ClientType? = <span class=\"n\">nil</span>)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L45","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L45","def":{"name":"client_list","args":[{"name":"type?","doc":null,"default_value":"nil","external_name":"type","restriction":"ClientType | ::Nil"}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"commands = [\"CLIENT\", \"LIST\"]\nif type = type?\n  commands = commands + [\"TYPE\", type.to_s.downcase]\nend\nstring_command(commands)\n"}},{"id":"client_setname(name:String)-instance-method","html_id":"client_setname(name:String)-instance-method","name":"client_setname","doc":"Set the current connection name. See [https://redis.io/commands/client-setname](https://redis.io/commands/client-setname).","summary":"<p>Set the current connection name.</p>","abstract":false,"args":[{"name":"name","doc":null,"default_value":"","external_name":"name","restriction":"String"}],"args_string":"(name : String)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L61","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L61","def":{"name":"client_setname","args":[{"name":"name","doc":null,"default_value":"","external_name":"name","restriction":"String"}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"(string_command([\"CLIENT\", \"SETNAME\", name])) == \"OK\""}},{"id":"client_unblock(id:Int,errorerror?:Bool=false)-instance-method","html_id":"client_unblock(id:Int,errorerror?:Bool=false)-instance-method","name":"client_unblock","doc":null,"summary":null,"abstract":false,"args":[{"name":"id","doc":null,"default_value":"","external_name":"id","restriction":"Int"},{"name":"error?","doc":null,"default_value":"false","external_name":"error","restriction":"Bool"}],"args_string":"(id : Int, error error? : Bool = <span class=\"n\">false</span>)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L65","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L65","def":{"name":"client_unblock","args":[{"name":"id","doc":null,"default_value":"","external_name":"id","restriction":"Int"},{"name":"error?","doc":null,"default_value":"false","external_name":"error","restriction":"Bool"}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"commands = [\"CLIENT\", \"UNBLOCK\", id.to_s]\nif error = error?\n  commands << \"ERROR\"\nend\ninteger_command(commands)\n"}},{"id":"fetch_hash(key:String)-instance-method","html_id":"fetch_hash(key:String)-instance-method","name":"fetch_hash","doc":"Return a `Hash(String, String)` representation of hash stored at *key*.","summary":"<p>Return a <code>Hash(String, String)</code> representation of hash stored at <em>key</em>.</p>","abstract":false,"args":[{"name":"key","doc":null,"default_value":"","external_name":"key","restriction":"String"}],"args_string":"(key : String)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L4","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L4","def":{"name":"fetch_hash","args":[{"name":"key","doc":null,"default_value":"","external_name":"key","restriction":"String"}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"data = hgetall(key)\nhash = {} of String => String\ndata.each_slice(2) do |__arg0|\n  key = __arg0[0]\n  value = __arg0[1]\n  hash[key.to_s] = value.to_s\nend\nhash\n"}},{"id":"fetch_hash(key:String,*fields)-instance-method","html_id":"fetch_hash(key:String,*fields)-instance-method","name":"fetch_hash","doc":"Return a `Hash(String, String)` representation of hash *fields* stored at *key*.","summary":"<p>Return a <code>Hash(String, String)</code> representation of hash <em>fields</em> stored at <em>key</em>.</p>","abstract":false,"args":[{"name":"key","doc":null,"default_value":"","external_name":"key","restriction":"String"},{"name":"fields","doc":null,"default_value":"","external_name":"fields","restriction":""}],"args_string":"(key : String, *fields)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L16","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L16","def":{"name":"fetch_hash","args":[{"name":"key","doc":null,"default_value":"","external_name":"key","restriction":"String"},{"name":"fields","doc":null,"default_value":"","external_name":"fields","restriction":""}],"double_splat":null,"splat_index":1,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"data = hmget(key, *fields)\nhash = {} of String => String | Nil\nfields.each_with_index do |field, i|\n  hash[field] = data[i].try(&.to_s)\nend\nhash\n"}},{"id":"zpopmax(key:String,countcount?:Int32?=nil)-instance-method","html_id":"zpopmax(key:String,countcount?:Int32?=nil)-instance-method","name":"zpopmax","doc":"Remove and return members with the highest scores in a sorted set.\nSee [https://redis.io/commands/zpopmax](https://redis.io/commands/zpopmax).","summary":"<p>Remove and return members with the highest scores in a sorted set.</p>","abstract":false,"args":[{"name":"key","doc":null,"default_value":"","external_name":"key","restriction":"String"},{"name":"count?","doc":null,"default_value":"nil","external_name":"count","restriction":"Int32 | ::Nil"}],"args_string":"(key : String, count count? : Int32? = <span class=\"n\">nil</span>)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L77","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L77","def":{"name":"zpopmax","args":[{"name":"key","doc":null,"default_value":"","external_name":"key","restriction":"String"},{"name":"count?","doc":null,"default_value":"nil","external_name":"count","restriction":"Int32 | ::Nil"}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"commands = [\"ZPOPMAX\", key]\nif count = count?\n  commands << count.to_s\nend\nstring_array_command(commands)\n"}},{"id":"zpopmin(key:String,countcount?:Int32?=nil)-instance-method","html_id":"zpopmin(key:String,countcount?:Int32?=nil)-instance-method","name":"zpopmin","doc":"Remove and return members with the lowest scores in a sorted set.\nSee [https://redis.io/commands/zpopmin](https://redis.io/commands/zpopmin).","summary":"<p>Remove and return members with the lowest scores in a sorted set.</p>","abstract":false,"args":[{"name":"key","doc":null,"default_value":"","external_name":"key","restriction":"String"},{"name":"count?","doc":null,"default_value":"nil","external_name":"count","restriction":"Int32 | ::Nil"}],"args_string":"(key : String, count count? : Int32? = <span class=\"n\">nil</span>)","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L89","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L89","def":{"name":"zpopmin","args":[{"name":"key","doc":null,"default_value":"","external_name":"key","restriction":"String"},{"name":"count?","doc":null,"default_value":"nil","external_name":"count","restriction":"Int32 | ::Nil"}],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"commands = [\"ZPOPMIN\", key]\nif count = count?\n  commands << count.to_s\nend\nstring_array_command(commands)\n"}}],"macros":[],"types":[{"html_id":"github.com/onyxframework/background/Redis/Commands/ClientType","path":"Redis/Commands/ClientType.html","kind":"enum","full_name":"Redis::Commands::ClientType","name":"ClientType","abstract":false,"superclass":null,"ancestors":[{"html_id":"github.com/onyxframework/background/Enum","kind":"struct","full_name":"Enum","name":"Enum"},{"html_id":"github.com/onyxframework/background/Comparable","kind":"module","full_name":"Comparable","name":"Comparable"},{"html_id":"github.com/onyxframework/background/Value","kind":"struct","full_name":"Value","name":"Value"},{"html_id":"github.com/onyxframework/background/Object","kind":"class","full_name":"Object","name":"Object"}],"locations":[{"filename":"ext/redis/commands.cr","line_number":37,"url":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr"}],"repository_name":"github.com/onyxframework/background","program":false,"enum":true,"alias":false,"aliased":"","const":false,"constants":[{"id":"Normal","name":"Normal","value":"0","doc":null,"summary":null},{"id":"Master","name":"Master","value":"1","doc":null,"summary":null},{"id":"Replica","name":"Replica","value":"2","doc":null,"summary":null},{"id":"Pubsub","name":"Pubsub","value":"3","doc":null,"summary":null}],"included_modules":[],"extended_modules":[],"subclasses":[],"including_types":[],"namespace":{"html_id":"github.com/onyxframework/background/Redis/Commands","kind":"module","full_name":"Redis::Commands","name":"Commands"},"doc":null,"summary":null,"class_methods":[],"constructors":[],"instance_methods":[{"id":"master?-instance-method","html_id":"master?-instance-method","name":"master?","doc":null,"summary":null,"abstract":false,"args":[],"args_string":"","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L39","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L39","def":{"name":"master?","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"self == Master"}},{"id":"normal?-instance-method","html_id":"normal?-instance-method","name":"normal?","doc":null,"summary":null,"abstract":false,"args":[],"args_string":"","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L38","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L38","def":{"name":"normal?","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"self == Normal"}},{"id":"pubsub?-instance-method","html_id":"pubsub?-instance-method","name":"pubsub?","doc":null,"summary":null,"abstract":false,"args":[],"args_string":"","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L41","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L41","def":{"name":"pubsub?","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"self == Pubsub"}},{"id":"replica?-instance-method","html_id":"replica?-instance-method","name":"replica?","doc":null,"summary":null,"abstract":false,"args":[],"args_string":"","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L40","source_link":"https://github.com/onyxframework/background/blob/dadf3ee043551a292f23036ee6aefa101274a952/src/ext/redis/commands.cr#L40","def":{"name":"replica?","args":[],"double_splat":null,"splat_index":null,"yields":null,"block_arg":null,"return_type":"","visibility":"Public","body":"self == Replica"}}],"macros":[],"types":[]}]}]}]}})